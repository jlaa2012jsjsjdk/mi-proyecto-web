<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciativas | Vox Schola</title>
    <link rel="stylesheet" href="estilos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .btn-apoyar { background: #f1f5f9; color: #0f172a; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; margin-top: 15px; }
        .btn-apoyar:hover { background: #8b5cf6; color: white; }
        .tag-categoria { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; padding: 4px 8px; background: #f5f3ff; color: #8b5cf6; border-radius: 6px; margin-bottom: 10px; display: inline-block; }
        .historial-section { margin-top: 60px; width: 100%; border-top: 2px dashed #e2e8f0; padding-top: 40px; }
        .card-archivada { opacity: 0.8; filter: grayscale(0.4); background: #fcfcfc; }
        .btn-reactivar { background: #0f172a; color: white; border: none; padding: 10px 15px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; margin-top: 10px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo"><i class="fas fa-layer-group"></i> Vox Schola</div>
        <div class="user-profile">
            <div class="avatar">J</div>
            <div class="user-info"><strong>Jose Luis A.</strong><span><i class="fas fa-circle" style="font-size: 0.5rem; color: #10b981;"></i> Verificado</span></div>
        </div>
        <nav class="nav-menu">
            <a href="index.html" class="nav-link"><i class="fas fa-house"></i> Inicio</a>
            <a href="votaciones.html" class="nav-link"><i class="fas fa-poll"></i> Votaciones</a>
            <a href="finanzas.html" class="nav-link"><i class="fas fa-chart-pie"></i> Finanzas</a>
            <a href="buzon.html" class="nav-link"><i class="fas fa-envelope"></i> Buzón</a>
            <a href="iniciativas.html" class="nav-link active"><i class="fas fa-lightbulb"></i> Iniciativas</a>
            <a href="perfil.html" class="nav-link"><i class="fas fa-user-circle"></i> Mi Perfil</a>
        </nav>
    </aside>

    <main class="main-content">
        <header class="welcome-section">
            <h1>Iniciativas Estudiantiles</h1>
            <p>Meta: 200 apoyos en 30 días.</p>
        </header>

        <div class="quick-grid">
            <div class="mini-card" style="border-left: 4px solid #8b5cf6; cursor: pointer;" onclick="document.getElementById('modalIdea').style.display='flex'">
                <div class="icon-square" style="background: #8b5cf6; color: white;"><i class="fas fa-plus"></i></div>
                <h4>Nueva Idea</h4>
                <span>Crear propuesta</span>
            </div>
        </div>

        <div id="contenedor-activas" class="summary-container">
            <p>Conectando con la base de datos...</p>
        </div>

        <div class="historial-section">
            <h2 style="margin-bottom: 25px; font-size: 1.5rem; color: #64748b;"><i class="fas fa-clock-rotate-left"></i> Historial / Reactivar</h2>
            <div id="contenedor-historial" class="summary-container"></div>
        </div>
    </main>

    <div id="modalIdea" class="modal">
        <div class="modal-content">
            <span style="float:right; cursor:pointer; font-size: 1.5rem;" onclick="document.getElementById('modalIdea').style.display='none'">&times;</span>
            <h3 style="margin-bottom: 20px;">Proponer Cambio</h3>
            <input type="text" id="tituloIdea" placeholder="Título..." style="width:100%; padding:12px; margin-bottom:15px; border-radius:10px; border:1px solid #ddd;">
            <textarea id="descIdea" rows="4" placeholder="Descripción..." style="width:100%; padding:12px; margin-bottom:15px; border-radius:10px; border:1px solid #ddd;"></textarea>
            <button style="background:#8b5cf6; color:white; border:none; width:100%; padding:15px; border-radius:12px; font-weight:bold; cursor:pointer;" onclick="crearNuevaIniciativa()">Publicar Propuesta</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDfJOXMY6usthm_FfYmyOAn65aHSEQytMo",
            authDomain: "voxschola.firebaseapp.com",
            projectId: "voxschola",
            storageBucket: "voxschola.firebasestorage.app",
            messagingSenderId: "730366058404",
            appId: "1:730366058404:web:87dcb2f97265900b5f2b31",
            measurementId: "G-FV36VXDV9D"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.crearNuevaIniciativa = async () => {
            const t = document.getElementById('tituloIdea').value;
            const d = document.getElementById('descIdea').value;
            if(!t || !d) return alert("Completa los campos");

            await addDoc(collection(db, "iniciativas"), {
                titulo: t, descripcion: d, categoria: "Estudiantil", apoyos: 0, fechaCreacion: Date.now()
            });
            document.getElementById('tituloIdea').value = "";
            document.getElementById('descIdea').value = "";
            document.getElementById('modalIdea').style.display = 'none';
        };

        window.votarIniciativa = async (id, apoyos) => {
            await updateDoc(doc(db, "iniciativas", id), { apoyos: apoyos + 1 });
        };

        window.reactivarIniciativa = async (id) => {
            await updateDoc(doc(db, "iniciativas", id), { fechaCreacion: Date.now() });
        };

        const q = query(collection(db, "iniciativas"), orderBy("fechaCreacion", "desc"));
        onSnapshot(q, (snap) => {
            const activas = document.getElementById('contenedor-activas');
            const historial = document.getElementById('contenedor-historial');
            activas.innerHTML = ""; historial.innerHTML = "";

            snap.forEach((s) => {
                const data = s.data();
                const id = s.id;
                const diasRestantes = 30 - Math.floor((Date.now() - data.fechaCreacion) / (1000 * 60 * 60 * 24));
                const esExpirada = diasRestantes <= 0 && data.apoyos < 200;

                const card = `
                    <div class="summary-card ${esExpirada ? 'card-archivada' : ''}">
                        <span class="tag-categoria">${data.categoria}</span>
                        <h3>${data.titulo}</h3>
                        <div class="vote-item">
                            <div class="progress-container" style="height:8px; background:#e2e8f0; border-radius:10px; margin:10px 0;">
                                <div style="height:100%; border-radius:10px; width:${(data.apoyos/200)*100}%; background:${esExpirada ? '#94a3b8' : '#8b5cf6'};"></div>
                            </div>
                            <div class="progress-stats" style="display:flex; justify-content:space-between; font-size:0.8rem;">
                                <span>${data.apoyos} Apoyos</span>
                                <span>${esExpirada ? 'Expirada' : diasRestantes + ' días'}</span>
                            </div>
                            ${esExpirada 
                                ? `<button class="btn-reactivar" onclick="reactivarIniciativa('${id}')"><i class="fas fa-sync-alt"></i> Reactivar</button>`
                                : `<button class="btn-apoyar" onclick="votarIniciativa('${id}', ${data.apoyos})"><i class="fas fa-arrow-up"></i> Apoyar</button>`
                            }
                        </div>
                    </div>`;
                if(esExpirada) historial.innerHTML += card;
                else activas.innerHTML += card;
            });
        });
    </script>
</body>
</html>